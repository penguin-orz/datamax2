name: å‘å¸ƒåˆ°PyPIå’Œåˆ›å»ºæ ‡ç­¾

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹ (major, minor, patch, prerelease)'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (å¯é€‰ï¼Œå¦‚æœæä¾›åˆ™å¿½ç•¥ç‰ˆæœ¬ç±»å‹)'
        required: false
        type: string
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶çš„ç‰ˆæœ¬æ ‡ç­¾
  push:
    tags:
      - 'v*'

# æ·»åŠ æƒé™å£°æ˜
permissions:
  contents: write    # å…è®¸åˆ›å»ºå’Œä¿®æ”¹ä»“åº“å†…å®¹
  packages: write    # å…è®¸å‘å¸ƒåŒ…
  pull-requests: write    # å…è®¸åˆ›å»ºå’Œä¿®æ”¹PR
  issues: write      # å…è®¸åˆ›å»ºå’Œä¿®æ”¹issues
  actions: read      # å…è®¸è¯»å–actions
  checks: write      # å…è®¸å†™å…¥æ£€æŸ¥ç»“æœ

env:
  PYTHON_VERSION: '3.10'

jobs:
  validate-and-test:
    name: éªŒè¯å’Œæµ‹è¯•
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_publish: ${{ steps.check.outputs.should_publish }}
      job_status: ${{ job.status }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel
        # æ£€æŸ¥requirements.txtæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å®‰è£…
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          echo "requirements.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
        fi

    - name: ç‰ˆæœ¬ç®¡ç†
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
          else
            # ä»setup.pyè·å–å½“å‰ç‰ˆæœ¬
            CURRENT_VERSION=$(python setup.py --version)
            echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

            # æ ¹æ®ç‰ˆæœ¬ç±»å‹è®¡ç®—æ–°ç‰ˆæœ¬
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}

            case "${{ github.event.inputs.version_type }}" in
              major)
                NEW_VERSION="$((MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
                ;;
              patch)
                NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
                ;;
              prerelease)
                NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))-rc.$(date +%s)"
                ;;
            esac
          fi
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"

          # æ›´æ–°setup.pyä¸­çš„ç‰ˆæœ¬
          sed -i "s/version='[^']*'/version='$NEW_VERSION'/g" setup.py

        else
          # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬
          NEW_VERSION=${GITHUB_REF#refs/tags/v}
          echo "æ ‡ç­¾ç‰ˆæœ¬: $NEW_VERSION"

          # æ›´æ–°setup.pyä¸­çš„ç‰ˆæœ¬
          sed -i "s/version='[^']*'/version='$NEW_VERSION'/g" setup.py
        fi

        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: éªŒè¯ç‰ˆæœ¬æ›´æ–°
      run: |
        python setup.py --version
        echo "Setup.pyç‰ˆæœ¬: $(python setup.py --version)"

    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        # æ£€æŸ¥setup.pyè¯­æ³•
        python -m py_compile setup.py

        # æ£€æŸ¥åŒ…æ˜¯å¦å¯ä»¥æ­£ç¡®å¯¼å…¥
        python -c "import setuptools; setuptools.setup()" --help-commands > /dev/null

    - name: æ„å»ºåŒ…
      run: |
        python -m build

    - name: éªŒè¯åŒ…
      run: |
        # æ£€æŸ¥åŒ…çš„å®Œæ•´æ€§
        python -m twine check dist/*

        # æµ‹è¯•å®‰è£…
        pip install dist/*.whl
        python -c "import datamax; print('åŒ…å¯¼å…¥æˆåŠŸ')"

    - name: æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘å¸ƒ
      id: check
      run: |
        # æ€»æ˜¯å…è®¸å‘å¸ƒ - è®©PyPIè‡ªå·±å¤„ç†é‡å¤ç‰ˆæœ¬çš„é”™è¯¯
        VERSION="${{ steps.version.outputs.version }}"
        echo "å‡†å¤‡å‘å¸ƒç‰ˆæœ¬: $VERSION"
        echo "should_publish=true" >> $GITHUB_OUTPUT
        echo "ç‰ˆæœ¬æ£€æŸ¥å®Œæˆï¼Œå…è®¸å‘å¸ƒ"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  debug-info:
    name: è°ƒè¯•ä¿¡æ¯
    needs: validate-and-test
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: è¾“å‡ºè°ƒè¯•ä¿¡æ¯
      run: |
        echo "=== è°ƒè¯•ä¿¡æ¯ ==="
        echo "validate-and-test.result: ${{ needs.validate-and-test.result }}"
        echo "validate-and-test.outputs.should_publish: ${{ needs.validate-and-test.outputs.should_publish }}"
        echo "validate-and-test.outputs.version: ${{ needs.validate-and-test.outputs.version }}"
        echo "github.event_name: ${{ github.event_name }}"
        echo "=== æ¡ä»¶åˆ¤æ–­ç»“æœ ==="
        echo "should_publish == 'true': ${{ needs.validate-and-test.outputs.should_publish == 'true' }}"
        echo "result == 'success': ${{ needs.validate-and-test.result == 'success' }}"
        echo "ç»¼åˆæ¡ä»¶: ${{ needs.validate-and-test.outputs.should_publish == 'true' && needs.validate-and-test.result == 'success' }}"

  publish-pypi:
    name: å‘å¸ƒåˆ°PyPI
    needs: validate-and-test
    if: needs.validate-and-test.outputs.should_publish == 'true' && needs.validate-and-test.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/pydatamax

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: å‘å¸ƒåˆ°æµ‹è¯•PyPI (å¯é€‰)
      if: contains(needs.validate-and-test.outputs.version, 'rc')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        verbose: true

    - name: å‘å¸ƒåˆ°PyPI
      if: ${{ !contains(needs.validate-and-test.outputs.version, 'rc') }}
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        verbose: true

  create-release:
    name: åˆ›å»ºGitHub Release
    needs: [validate-and-test, publish-pypi]
    if: needs.validate-and-test.outputs.should_publish == 'true' && needs.validate-and-test.result == 'success'
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æäº¤ç‰ˆæœ¬æ›´æ–°
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add setup.py
        git commit -m "bump: ç‰ˆæœ¬æ›´æ–°è‡³ v${{ needs.validate-and-test.outputs.version }}" || exit 0
        git push

    - name: åˆ›å»ºæ ‡ç­¾
      if: github.event_name == 'workflow_dispatch'
      run: |
        git tag -a "v${{ needs.validate-and-test.outputs.version }}" -m "Release v${{ needs.validate-and-test.outputs.version }}"
        git push origin "v${{ needs.validate-and-test.outputs.version }}"

    - name: æ”¶é›†å˜æ›´ä¿¡æ¯
      id: collect_changes
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        CURRENT_VERSION="v${{ needs.validate-and-test.outputs.version }}"
        
        echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        if [ -n "$PREVIOUS_TAG" ]; then
          # æ”¶é›†æäº¤ä¿¡æ¯
          echo "=== COMMITS ===" > changes_raw.txt
          git log --pretty=format:"COMMIT: %s%nAUTHOR: %an <%ae>%nDATE: %ad%nHASH: %h%nBODY: %b%n---" --date=short $PREVIOUS_TAG..HEAD >> changes_raw.txt
          
          # æ”¶é›†æ–‡ä»¶å˜æ›´
          echo "" >> changes_raw.txt
          echo "=== FILE CHANGES ===" >> changes_raw.txt
          git diff --name-status $PREVIOUS_TAG..HEAD >> changes_raw.txt
          
          # æ”¶é›†è¯¦ç»†çš„æ–‡ä»¶å˜æ›´ï¼ˆé™åˆ¶å¤§å°ï¼‰
          echo "" >> changes_raw.txt
          echo "=== DETAILED CHANGES ===" >> changes_raw.txt
          git diff --stat $PREVIOUS_TAG..HEAD >> changes_raw.txt
          
          # è·å–ä»“åº“ä¿¡æ¯
          echo "" >> changes_raw.txt
          echo "=== REPOSITORY INFO ===" >> changes_raw.txt
          echo "Repository: ${{ github.repository }}" >> changes_raw.txt
          echo "Previous Tag: $PREVIOUS_TAG" >> changes_raw.txt
          echo "Current Version: $CURRENT_VERSION" >> changes_raw.txt
          echo "Project: DataMax - Pythonæ•°æ®å¤„ç†å·¥å…·åŒ…" >> changes_raw.txt
        else
          echo "=== FIRST RELEASE ===" > changes_raw.txt
          echo "This is the first release of DataMax" >> changes_raw.txt
        fi

    - name: AIæ™ºèƒ½æ€»ç»“å˜æ›´
      id: ai_summary
      run: |
        if [ ! -f "changes_raw.txt" ]; then
          echo "No changes file found, skipping AI summary"
          echo "ai_summary_available=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # åˆ›å»ºAIæ€»ç»“è„šæœ¬
        cat > ai_summarize.py << 'EOF'
        import json
        import sys
        import os
        import requests
        from datetime import datetime

        def summarize_with_openai(changes_text, api_key):
            """ä½¿ç”¨OpenAI APIè¿›è¡Œæ€»ç»“"""
            try:
                headers = {
                    'Authorization': f'Bearer {api_key}',
                    'Content-Type': 'application/json'
                }
                
                prompt = f"""è¯·ä½œä¸ºä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å‘å¸ƒç»ç†ï¼Œåˆ†æä»¥ä¸‹Gitå˜æ›´ä¿¡æ¯ï¼Œä¸ºDataMaxï¼ˆä¸€ä¸ªPythonæ•°æ®å¤„ç†å·¥å…·åŒ…ï¼‰ç”Ÿæˆä¸“ä¸šçš„ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ã€‚

è¯·ç”¨ä¸­æ–‡è¾“å‡ºï¼Œæ ¼å¼è¦æ±‚ï¼š
1. ğŸ“‹ **ç‰ˆæœ¬äº®ç‚¹** - ç”¨1-2å¥è¯æ¦‚æ‹¬æœ¬æ¬¡æ›´æ–°çš„ä¸»è¦ç‰¹æ€§
2. âœ¨ **æ–°å¢åŠŸèƒ½** - åˆ—å‡ºæ–°åŠŸèƒ½ï¼Œç”¨emojiæ ‡è®°
3. ğŸ› **é—®é¢˜ä¿®å¤** - åˆ—å‡ºä¿®å¤çš„é—®é¢˜
4. ğŸ”§ **æ”¹è¿›ä¼˜åŒ–** - åˆ—å‡ºæ€§èƒ½å’Œä½“éªŒæ”¹è¿›
5. ğŸ“š **æ–‡æ¡£æ›´æ–°** - æ–‡æ¡£ç›¸å…³å˜æ›´
6. ğŸ§ª **æµ‹è¯•ç›¸å…³** - æµ‹è¯•ç›¸å…³å˜æ›´

Gitå˜æ›´ä¿¡æ¯ï¼š
{changes_text}

è¯·ç”Ÿæˆä¸“ä¸šã€æ¸…æ™°ã€ç”¨æˆ·å‹å¥½çš„å‘å¸ƒè¯´æ˜ï¼Œé‡ç‚¹çªå‡ºå¯¹ç”¨æˆ·çš„ä»·å€¼ã€‚"""

                data = {
                    "model": "gpt-3.5-turbo",
                    "messages": [
                        {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å‘å¸ƒç»ç†ï¼Œæ“…é•¿å°†æŠ€æœ¯å˜æ›´è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„å‘å¸ƒè¯´æ˜ã€‚"},
                        {"role": "user", "content": prompt}
                    ],
                    "max_tokens": 1000,
                    "temperature": 0.3
                }
                
                response = requests.post('https://api.openai.com/v1/chat/completions', 
                                       headers=headers, json=data, timeout=30)
                
                if response.status_code == 200:
                    result = response.json()
                    return result['choices'][0]['message']['content'].strip()
                else:
                    return None
            except Exception as e:
                print(f"OpenAI API error: {e}")
                return None

        def summarize_with_gemini(changes_text, api_key):
            """ä½¿ç”¨Google Gemini 2.5 Flash APIè¿›è¡Œæ€»ç»“"""
            try:
                url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key={api_key}"
                
                prompt = f"""è¯·ä½œä¸ºä¸“ä¸šçš„è½¯ä»¶å‘å¸ƒç»ç†ï¼Œåˆ†æä»¥ä¸‹Gitå˜æ›´ä¿¡æ¯ï¼Œä¸ºDataMaxï¼ˆä¸€ä¸ªPythonæ•°æ®å¤„ç†å·¥å…·åŒ…ï¼‰ç”Ÿæˆä¸“ä¸šçš„ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ã€‚

è¯·ç”¨ä¸­æ–‡è¾“å‡ºï¼Œæ ¼å¼è¦æ±‚ï¼š
1. ğŸ“‹ **ç‰ˆæœ¬äº®ç‚¹** - ç”¨1-2å¥è¯æ¦‚æ‹¬æœ¬æ¬¡æ›´æ–°çš„ä¸»è¦ç‰¹æ€§å’Œä»·å€¼
2. âœ¨ **æ–°å¢åŠŸèƒ½** - åˆ—å‡ºæ–°åŠŸèƒ½ï¼Œé‡ç‚¹è¯´æ˜å¯¹ç”¨æˆ·çš„ä»·å€¼
3. ğŸ› **é—®é¢˜ä¿®å¤** - åˆ—å‡ºä¿®å¤çš„é—®é¢˜ï¼Œè¯´æ˜å¯¹ç”¨æˆ·ä½“éªŒçš„æ”¹å–„
4. ğŸ”§ **æ”¹è¿›ä¼˜åŒ–** - åˆ—å‡ºæ€§èƒ½å’Œä½“éªŒæ”¹è¿›
5. ğŸ“š **æ–‡æ¡£æ›´æ–°** - æ–‡æ¡£ç›¸å…³å˜æ›´ï¼ˆå¦‚æœæœ‰ï¼‰
6. ğŸ§ª **æµ‹è¯•ç›¸å…³** - æµ‹è¯•ç›¸å…³å˜æ›´ï¼ˆå¦‚æœæœ‰ï¼‰

Gitå˜æ›´ä¿¡æ¯ï¼š
{changes_text}

è¯·ç”Ÿæˆä¸“ä¸šã€æ¸…æ™°ã€ç”¨æˆ·å‹å¥½çš„å‘å¸ƒè¯´æ˜ï¼Œé‡ç‚¹çªå‡ºå¯¹ç”¨æˆ·çš„ä»·å€¼å’Œå½±å“ã€‚"""

                data = {
                    "contents": [{
                        "parts": [{"text": prompt}]
                    }],
                    "generationConfig": {
                        "temperature": 0.2,
                        "maxOutputTokens": 1500,
                        "topP": 0.8,
                        "topK": 40
                    }
                }
                
                response = requests.post(url, json=data, timeout=45)
                
                if response.status_code == 200:
                    result = response.json()
                    return result['candidates'][0]['content']['parts'][0]['text'].strip()
                else:
                    print(f"Gemini API error: {response.status_code}, {response.text}")
                    return None
            except Exception as e:
                print(f"Gemini API error: {e}")
                return None

        def create_fallback_summary(changes_text):
            """åˆ›å»ºfallbackæ€»ç»“"""
            lines = changes_text.split('\n')
            commits = []
            files_changed = 0
            
            for line in lines:
                if line.startswith('COMMIT:'):
                    commit_msg = line.replace('COMMIT:', '').strip()
                    if commit_msg and not commit_msg.startswith('Merge'):
                        commits.append(commit_msg)
                elif '|' in line and ('+' in line or '-' in line):
                    files_changed += 1
            
            summary = "### ğŸ“‹ ç‰ˆæœ¬äº®ç‚¹\n\n"
            summary += f"æœ¬æ¬¡æ›´æ–°åŒ…å« {len(commits)} ä¸ªæäº¤ï¼Œæ¶‰åŠ {files_changed} ä¸ªæ–‡ä»¶çš„å˜æ›´ã€‚\n\n"
            
            if commits:
                summary += "### âœ¨ ä¸»è¦å˜æ›´\n\n"
                for commit in commits[:10]:  # é™åˆ¶æ˜¾ç¤ºæ•°é‡
                    if any(keyword in commit.lower() for keyword in ['feat', 'add', 'æ–°å¢', 'æ·»åŠ ']):
                        summary += f"- âœ¨ {commit}\n"
                    elif any(keyword in commit.lower() for keyword in ['fix', 'ä¿®å¤', 'bug']):
                        summary += f"- ğŸ› {commit}\n"
                    elif any(keyword in commit.lower() for keyword in ['doc', 'æ–‡æ¡£']):
                        summary += f"- ğŸ“š {commit}\n"
                    elif any(keyword in commit.lower() for keyword in ['test', 'æµ‹è¯•']):
                        summary += f"- ğŸ§ª {commit}\n"
                    elif any(keyword in commit.lower() for keyword in ['perf', 'æ€§èƒ½', 'ä¼˜åŒ–']):
                        summary += f"- âš¡ {commit}\n"
                    else:
                        summary += f"- ğŸ“ {commit}\n"
            
            return summary

        # ä¸»é€»è¾‘
        try:
            with open('changes_raw.txt', 'r', encoding='utf-8') as f:
                changes_text = f.read()
            
            if not changes_text.strip():
                print("No changes to summarize")
                sys.exit(0)
            
            ai_summary = None
            
            # ä¼˜å…ˆå°è¯•ä½¿ç”¨Gemini 2.5 Flash APIï¼ˆå…è´¹ä¸”æ€§èƒ½ä¼˜ç§€ï¼‰
            gemini_key = os.getenv('GEMINI_API_KEY')
            if gemini_key:
                print("Trying Gemini 2.5 Flash API...")
                ai_summary = summarize_with_gemini(changes_text, gemini_key)
            
            # å¦‚æœGeminiå¤±è´¥ï¼Œå°è¯•OpenAI
            if not ai_summary:
                openai_key = os.getenv('OPENAI_API_KEY')
                if openai_key:
                    print("Trying OpenAI API as fallback...")
                    ai_summary = summarize_with_openai(changes_text, openai_key)
            
            # å¦‚æœAIæ€»ç»“å¤±è´¥ï¼Œä½¿ç”¨fallback
            if not ai_summary:
                print("AI APIs unavailable, using fallback summary...")
                ai_summary = create_fallback_summary(changes_text)
            
            # ä¿å­˜æ€»ç»“ç»“æœ
            with open('ai_summary.txt', 'w', encoding='utf-8') as f:
                f.write(ai_summary)
            
            print("AI summary generated successfully")
            
        except Exception as e:
            print(f"Error in AI summarization: {e}")
            # åˆ›å»ºåŸºç¡€æ€»ç»“
            fallback = create_fallback_summary(changes_text if 'changes_text' in locals() else "")
            with open('ai_summary.txt', 'w', encoding='utf-8') as f:
                f.write(fallback)
        
        EOF
        
        # è¿è¡ŒAIæ€»ç»“
        python ai_summarize.py
        
        if [ -f "ai_summary.txt" ]; then
          echo "ai_summary_available=true" >> $GITHUB_OUTPUT
        else
          echo "ai_summary_available=false" >> $GITHUB_OUTPUT
        fi
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    - name: ç”Ÿæˆæœ€ç»ˆçš„Release Notes
      id: final_changelog
      run: |
        PREVIOUS_TAG="${{ steps.collect_changes.outputs.previous_tag }}"
        CURRENT_VERSION="${{ steps.collect_changes.outputs.current_version }}"
        
        # åˆ›å»ºRelease Noteså¤´éƒ¨
        cat > CHANGELOG.md << EOF
        ## ğŸš€ DataMax v${{ needs.validate-and-test.outputs.version }}
        
        > **å‘å¸ƒæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')  
        > **PyPIåŒ…**: [pydatamax ${{ needs.validate-and-test.outputs.version }}](https://pypi.org/project/pydatamax/${{ needs.validate-and-test.outputs.version }}/)
        
        ### ğŸ“¦ å®‰è£…æ–¹å¼
        
        \`\`\`bash
        pip install pydatamax==${{ needs.validate-and-test.outputs.version }}
        \`\`\`
        
        EOF
        
        # æ·»åŠ AIæ€»ç»“å†…å®¹
        if [ "${{ steps.ai_summary.outputs.ai_summary_available }}" = "true" ] && [ -f "ai_summary.txt" ]; then
          echo "" >> CHANGELOG.md
          cat ai_summary.txt >> CHANGELOG.md
          echo "" >> CHANGELOG.md
        else
          # Fallbackåˆ°åŸå§‹æ–¹æ³•
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### ğŸ“ æ›´æ–°å†…å®¹" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "è‡ª $PREVIOUS_TAG ä»¥æ¥çš„æ›´æ”¹:" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # åˆ†ç±»æäº¤ä¿¡æ¯
            git log --pretty=format:"%s|%h" $PREVIOUS_TAG..HEAD | while IFS='|' read -r subject hash; do
              if echo "$subject" | grep -qi "^feat\|^add\|^æ–°å¢"; then
                echo "- âœ¨ $subject \`$hash\`" >> CHANGELOG.md
              elif echo "$subject" | grep -qi "^fix\|^ä¿®å¤\|^bug"; then
                echo "- ğŸ› $subject \`$hash\`" >> CHANGELOG.md
              elif echo "$subject" | grep -qi "^docs\|^æ–‡æ¡£"; then
                echo "- ğŸ“š $subject \`$hash\`" >> CHANGELOG.md
              else
                echo "- ğŸ“ $subject \`$hash\`" >> CHANGELOG.md
              fi
            done
            echo "" >> CHANGELOG.md
          else
            echo "### ğŸ‰ é¦–æ¬¡å‘å¸ƒ" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "DataMax æ˜¯ä¸€ä¸ªå¼ºå¤§çš„Pythonæ•°æ®å¤„ç†å·¥å…·åŒ…ï¼Œæ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼çš„è§£æå’Œå¤„ç†ã€‚" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
        fi
        
        # æ·»åŠ è´¡çŒ®è€…ä¿¡æ¯
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ğŸ‘¥ è´¡çŒ®è€…" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"%an|%ae" $PREVIOUS_TAG..HEAD | sort -u | while IFS='|' read -r name email; do
            if [[ "$email" == *"@users.noreply.github.com" ]]; then
              username=$(echo "$email" | sed 's/@users.noreply.github.com//')
              echo "- [@$username](https://github.com/$username)" >> CHANGELOG.md
            else
              echo "- $name" >> CHANGELOG.md
            fi
          done
          echo "" >> CHANGELOG.md
        fi
        
        # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯å’Œé“¾æ¥
        cat >> CHANGELOG.md << EOF
        ### ğŸ“Š ç‰ˆæœ¬ç»Ÿè®¡
        
        EOF
        
        if [ -n "$PREVIOUS_TAG" ]; then
          COMMIT_COUNT=$(git rev-list --count $PREVIOUS_TAG..HEAD)
          FILES_CHANGED=$(git diff --name-only $PREVIOUS_TAG..HEAD | wc -l)
          echo "- ğŸ“ˆ æ–°å¢æäº¤: $COMMIT_COUNT ä¸ª" >> CHANGELOG.md
          echo "- ğŸ“ æ–‡ä»¶å˜æ›´: $FILES_CHANGED ä¸ª" >> CHANGELOG.md
        fi
        
        cat >> CHANGELOG.md << EOF
        
        ### ğŸ”— ç›¸å…³é“¾æ¥
        
        - ğŸ“– [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }})
        - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
        - ğŸ’¬ [è®¨è®ºåŒº](https://github.com/${{ github.repository }}/discussions)
        - ğŸ“¦ [PyPIåŒ…](https://pypi.org/project/pydatamax/)
        
        ---
        
        **å®Œæ•´æ›´æ–°æ—¥å¿—**: [\$PREVIOUS_TAG...v${{ needs.validate-and-test.outputs.version }}](https://github.com/${{ github.repository }}/compare/\$PREVIOUS_TAG...v${{ needs.validate-and-test.outputs.version }})
        EOF

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.validate-and-test.outputs.version }}
        name: ğŸš€ DataMax v${{ needs.validate-and-test.outputs.version }}
        body_path: CHANGELOG.md
        files: |
          dist/*
        draft: false
        prerelease: ${{ contains(needs.validate-and-test.outputs.version, 'rc') }}
        token: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        generate_release_notes: true

  notify:
    name: å‘å¸ƒé€šçŸ¥
    needs: [validate-and-test, publish-pypi, create-release]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      if: needs.publish-pypi.result == 'success' && needs.create-release.result == 'success'
      run: |
        echo "ğŸ‰ DataMax v${{ needs.validate-and-test.outputs.version }} å‘å¸ƒæˆåŠŸ!"
        echo "ğŸ“¦ PyPI: https://pypi.org/project/pydatamax/${{ needs.validate-and-test.outputs.version }}/"
        echo "ğŸ·ï¸ GitHub: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.validate-and-test.outputs.version }}"

    - name: å‘å¸ƒå¤±è´¥é€šçŸ¥
      if: needs.publish-pypi.result == 'failure' || needs.create-release.result == 'failure'
      run: |
        echo "âŒ DataMax v${{ needs.validate-and-test.outputs.version }} å‘å¸ƒå¤±è´¥!"
        echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
