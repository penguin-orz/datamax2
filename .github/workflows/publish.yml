name: å‘å¸ƒåˆ°PyPIå’Œåˆ›å»ºæ ‡ç­¾

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹ (major, minor, patch, prerelease)'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (å¯é€‰ï¼Œå¦‚æœæä¾›åˆ™å¿½ç•¥ç‰ˆæœ¬ç±»å‹)'
        required: false
        type: string
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶çš„ç‰ˆæœ¬æ ‡ç­¾
  push:
    tags:
      - 'v*'

env:
  PYTHON_VERSION: '3.10'

jobs:
  validate-and-test:
    name: éªŒè¯å’Œæµ‹è¯•
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_publish: ${{ steps.check.outputs.should_publish }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel
        pip install -r requirements.txt

    - name: ç‰ˆæœ¬ç®¡ç†
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
          else
            # ä»setup.pyè·å–å½“å‰ç‰ˆæœ¬
            CURRENT_VERSION=$(python setup.py --version)
            echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

            # æ ¹æ®ç‰ˆæœ¬ç±»å‹è®¡ç®—æ–°ç‰ˆæœ¬
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}

            case "${{ github.event.inputs.version_type }}" in
              major)
                NEW_VERSION="$((MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
                ;;
              patch)
                NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
                ;;
              prerelease)
                NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))-rc.$(date +%s)"
                ;;
            esac
          fi
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"

          # æ›´æ–°setup.pyä¸­çš„ç‰ˆæœ¬
          sed -i "s/version='[^']*'/version='$NEW_VERSION'/g" setup.py

        else
          # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬
          NEW_VERSION=${GITHUB_REF#refs/tags/v}
          echo "æ ‡ç­¾ç‰ˆæœ¬: $NEW_VERSION"

          # æ›´æ–°setup.pyä¸­çš„ç‰ˆæœ¬
          sed -i "s/version='[^']*'/version='$NEW_VERSION'/g" setup.py
        fi

        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: éªŒè¯ç‰ˆæœ¬æ›´æ–°
      run: |
        python setup.py --version
        echo "Setup.pyç‰ˆæœ¬: $(python setup.py --version)"

    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        # æ£€æŸ¥setup.pyè¯­æ³•
        python -m py_compile setup.py

        # æ£€æŸ¥åŒ…æ˜¯å¦å¯ä»¥æ­£ç¡®å¯¼å…¥
        python -c "import setuptools; setuptools.setup()" --help-commands > /dev/null

    - name: æ„å»ºåŒ…
      run: |
        python -m build

    - name: éªŒè¯åŒ…
      run: |
        # æ£€æŸ¥åŒ…çš„å®Œæ•´æ€§
        python -m twine check dist/*

        # æµ‹è¯•å®‰è£…
        pip install dist/*.whl
        python -c "import datamax; print('åŒ…å¯¼å…¥æˆåŠŸ')"

    - name: æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘å¸ƒ
      id: check
      run: |
        # æ£€æŸ¥PyPIä¸Šæ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬
        VERSION="${{ steps.version.outputs.version }}"
        if pip index versions datamax | grep -q "$VERSION"; then
          echo "ç‰ˆæœ¬ $VERSION å·²å­˜åœ¨äºPyPI"
          echo "should_publish=false" >> $GITHUB_OUTPUT
        else
          echo "ç‰ˆæœ¬ $VERSION ä¸å­˜åœ¨äºPyPIï¼Œå¯ä»¥å‘å¸ƒ"
          echo "should_publish=true" >> $GITHUB_OUTPUT
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  publish-pypi:
    name: å‘å¸ƒåˆ°PyPI
    needs: validate-and-test
    if: needs.validate-and-test.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/datamax

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: å‘å¸ƒåˆ°æµ‹è¯•PyPI (å¯é€‰)
      if: contains(needs.validate-and-test.outputs.version, 'rc')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        verbose: true

    - name: å‘å¸ƒåˆ°PyPI
      if: ${{ !contains(needs.validate-and-test.outputs.version, 'rc') }}
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        verbose: true

  create-release:
    name: åˆ›å»ºGitHub Release
    needs: [validate-and-test, publish-pypi]
    if: needs.validate-and-test.outputs.should_publish == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æäº¤ç‰ˆæœ¬æ›´æ–°
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add setup.py
        git commit -m "bump: ç‰ˆæœ¬æ›´æ–°è‡³ v${{ needs.validate-and-test.outputs.version }}" || exit 0
        git push

    - name: åˆ›å»ºæ ‡ç­¾
      if: github.event_name == 'workflow_dispatch'
      run: |
        git tag -a "v${{ needs.validate-and-test.outputs.version }}" -m "Release v${{ needs.validate-and-test.outputs.version }}"
        git push origin "v${{ needs.validate-and-test.outputs.version }}"

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -n "$PREVIOUS_TAG" ]; then
          echo "# æ›´æ–°æ—¥å¿—" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## v${{ needs.validate-and-test.outputs.version }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # è·å–æäº¤å†å²
          echo "### æ›´æ”¹å†…å®¹" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # è·å–è´¡çŒ®è€…
          echo "### è´¡çŒ®è€…" >> CHANGELOG.md
          git log --pretty=format:"- %an" $PREVIOUS_TAG..HEAD | sort -u >> CHANGELOG.md
        else
          echo "# DataMax v${{ needs.validate-and-test.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "é¦–æ¬¡å‘å¸ƒç‰ˆæœ¬" >> CHANGELOG.md
        fi

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.validate-and-test.outputs.version }}
        name: DataMax v${{ needs.validate-and-test.outputs.version }}
        body_path: CHANGELOG.md
        files: |
          dist/*
        draft: false
        prerelease: ${{ contains(needs.validate-and-test.outputs.version, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: å‘å¸ƒé€šçŸ¥
    needs: [validate-and-test, publish-pypi, create-release]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      if: needs.publish-pypi.result == 'success' && needs.create-release.result == 'success'
      run: |
        echo "ğŸ‰ DataMax v${{ needs.validate-and-test.outputs.version }} å‘å¸ƒæˆåŠŸ!"
        echo "ğŸ“¦ PyPI: https://pypi.org/project/datamax/${{ needs.validate-and-test.outputs.version }}/"
        echo "ğŸ·ï¸ GitHub: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.validate-and-test.outputs.version }}"

    - name: å‘å¸ƒå¤±è´¥é€šçŸ¥
      if: needs.publish-pypi.result == 'failure' || needs.create-release.result == 'failure'
      run: |
        echo "âŒ DataMax v${{ needs.validate-and-test.outputs.version }} å‘å¸ƒå¤±è´¥!"
        echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
